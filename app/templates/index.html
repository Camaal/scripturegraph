{% extends "base.html" %}

{% block content %}
<div id="sourceBookName">
  <h1>{{defaultbookname}}</h1>
</div>
<div class="parallel">
    <div class="collection">
      <h6 class="collection-title">Source Connections</h6>
      <div class="color-scale">
        <div class="min">1</div>
        <div class="max">436</div>
      </div>
      <div class="verses">
        <div id="source_text">
            {% for i in range(1, dchapters)%}
                <h4>Chapter {{i}}</h4>
                {% for verse in dverses%}
                    {% if verse.chapter==i%}
                    <span class="scripture">
                           <span style="color:rgba{{verse.norm_degree | degreeColor}};">
                              <span class="verse_num" data-degree="{{verse.degree}}">{{verse.verse}}</span>
                               <a href="#" class="verseFilter" verse_id="{{verse.Id}}" style="text-decoration: none; color:rgba{{verse.norm_degree | degreeColor}};">{{verse.text}}</a><sup>{{verse.degree}}</sup>
                           </span>
                    </span>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
      </div>
    </div>
    <div id="graph-container" class="collection-target">
      <h6 class="collection-title">Cross-References</h6>
      <div id="graph"></div>
      <div class="color-scale">
        <div class="min">1</div>
        <div class="max">436</div>
      </div>
      <div class="verses">
        <div id="target_text" class="cross-references">
            {% for author in tauthors %}
                <div class="person">
                    <span class="material-icons">account_circle</span>
                    <h4>{{author.author}}</h4>
                </div>
                {% for b in tbooks if b.author == author.author %}
                       {% for item in joins%}
                           {% if b.book == item.book %}
                               {% if b.chapter == item.chapter %}
                                <span class="scripture">
                                     <span style="color:rgba{{item.norm_degree | degreeColor}};">
                                        {{item.text}}<sup>{{item.degree}}</sup>
                                     </span>
                                </span>
                                <h6 class="reference-name">{{b.book_name}} {{b.chapter}}: {{item.verse}}</h6>
                               {% endif %}
                           {% endif %}
                        {% endfor %}
                {% endfor %}
            {% endfor %}
        </div>
      </div>
      <script>
          // Add a method to the graph model that returns an
          // object with every neighbors of a node inside:
          sigma.classes.graph.addMethod('neighbors', function(nodeId) {
              var k,
                  neighbors = {},
                  index = this.allNeighborsIndex[nodeId] || {};

              for (k in index)
                  neighbors[k] = this.nodesIndex[k];

              return neighbors;
          });


          var obj = JSON.parse('{{ data|safe }}');
          var s = new sigma({
              graph: obj,
              renderers: [{
                  container: 'graph',
                  type: 'canvas',
              }],
              settings: {
                  labelThreshold: 10,
                  defaultLabelSize: 12,
                  defaultLabelColor: "#fff",
                  defaultLabelBGColor: "#ddd",
                  defaultHoverLabelBGColor: "#002147",
                  defaultLabelHoverColor: "#fff",
                  font: 'Source Serif Pro',
                  singleHover: true,
                  drawEdges: true,
                  drawEdgeLabels: false,
                  webglEdgesBatchSize: 5,
                  minNodeSize: 1,
                  maxNodeSize: 7,
                  minEdgeSize: 0.2,
                  maxEdgeSize: 0.5,
                  batchEdgesDrawing: true
              },
              function(s) {
                  // We first need to save the original colors of our
                  // nodes and edges, like this:
                  s.graph.nodes().forEach(function(n) {
                      n.originalColor = n.color;
                  });
                  s.graph.edges().forEach(function(e) {
                      e.originalColor = e.color;
                  });

                  // When a node is clicked, we check for each node
                  // if it is a neighbor of the clicked one. If not,
                  // we set its color as grey, and else, it takes its
                  // original color.
                  // We do the same for the edges, and we only keep
                  // edges that have both extremities colored.
                  s.bind('clickNode', function(e) {
                      var nodeId = e.data.node.id,
                          toKeep = s.graph.neighbors(nodeId);
                      toKeep[nodeId] = e.data.node;

                      s.graph.nodes().forEach(function(n) {
                          if (toKeep[n.id])
                              n.color = n.originalColor;
                          else
                              n.color = '#eee';
                      });

                      s.graph.edges().forEach(function(e) {
                          if (toKeep[e.source] && toKeep[e.target])
                              e.color = e.originalColor;
                          else
                              e.color = '#eee';
                      });

                      // Since the data has been modified, we need to
                      // call the refresh method to make the colors
                      // update effective.
                      s.refresh();
                  });

                  // When the stage is clicked, we just color each
                  // node and edge with its original color.
                  s.bind('clickStage', function(e) {
                      s.graph.nodes().forEach(function(n) {
                          n.color = n.originalColor;
                      });

                      s.graph.edges().forEach(function(e) {
                          e.color = e.originalColor;
                      });

                      // Same as in the previous event:
                      s.refresh();
                  });
              }
          });
      </script>
    </div>
</div>

{% endblock %}

{% block script %}
<script type="application/javascript">
    $(document).ready(function () {

        $('.verseFilter').on('click', function (){
            const verse_id = $(this).attr('verse_id');

            let getSourceByBook = $.ajax({
                url: '/filter_target',
                type: 'POST',
                data: {Id: verse_id}
            });

            getSourceByBook.done(function (data) {
                $('#graph-container').html(data);
            })
        });
    });
</script>
{% endblock %}